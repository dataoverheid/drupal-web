<?php

/**
 * @file
 */

use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Link;
use Drupal\Core\Render\Markup;
use Drupal\Core\Url;
use Drupal\node\NodeInterface;
use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;

/**
 * Implements hook_theme().
 */
function donl_theme($existing, $type, $theme, $path) {
  return [
    'donl_content_header_block' => [
      'variables' => [
        'title' => '',
        'type' => '',
        'image' => '',
        'content' => [],
        'links' => [],
        'search_form' => [],
        'mobile_search_form' => [],
        'suggestions' => [],
      ],
    ],
    'donl_privacy_statement' => [
      'variables' => [],
    ],
    'application' => [
      'variables' => [
        'node' => NULL,
        'backLink' => NULL,
        'editLinks' => [],
        'search' => '',
        'link' => '',
        'tabs' => '',
        'panels' => '',
      ],
    ],
    'application-panel-description' => [
      'variables' => [
        'tags' => [],
        'node' => NULL,
        'logo' => NULL,
      ],
    ],
    'datarequest' => [
      'variables' => [
        'node' => NULL,
        'backLink' => NULL,
        'editLinks' => [],
        'search' => '',
        'tabs' => '',
        'panels' => '',
        'extraInfo' => '',
      ],
    ],
    'datarequest-panel-request' => [
      'variables' => [
        'datarequest' => NULL,
      ],
    ],
    'datarequest-panel-reply' => [
      'variables' => [
        'datarequest' => NULL,
      ],
    ],
    'datarequest-panel-relations' => [
      'variables' => [
        'datarequest' => NULL,
      ],
    ],
    'dataservice' => [
      'variables' => [
        'node' => NULL,
        'backLink' => NULL,
        'editLinks' => [],
        'search' => '',
        'tabs' => '',
        'panels' => '',
      ],
    ],
    'dataservice-panel-description' => [
      'variables' => [
        'node' => NULL,
      ],
    ],
    'dataservice-panel-metadata' => [
      'variables' => [
        'node' => NULL,
      ],
    ],
    'donl_user_profile' => [
      'variables' => [
        'editLinks' => [],
        'search' => NULL,
        'user' => NULL,
        'user_registered_since' => '',
        'tabs' => [],
        'panels' => [],
      ],
    ],
    'donl_user_profile-metadata' => [
      'variables' => [
        'user' => NULL,
        'user_registered_since' => '',
      ],
    ],
    'manage-content-table' => [
      'variables' => [
        'links' => [],
        'rows' => [],
        'empty_text' => t('No data found'),
        'pagination' => NULL,
      ],
    ],
    'donl_tag_cloud_block' => [
      'variables' => [
        'tags' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_element_info_alter().
 */
function donl_element_info_alter(array &$types) {
  // Attach our extra CSS for toolbar icons.
  if (isset($types['toolbar'])) {
    $types['toolbar']['#attached']['library'][] = 'donl/toolbar';
  }
}

/**
 * Implements hook_preprocess_html().
 */
function donl_preprocess_html(&$variables) {
  if (\Drupal::service('path.matcher')->isFrontPage()) {
    $script = file_get_contents(__DIR__ . '/templates/schema.json');

    $variables['#attached']['html_head'][] = [
      [
        '#tag' => 'script',
        '#attributes' => ['type' => 'application/ld+json'],
        '#value' => Markup::create($script),
        '#weight' => -1,
      ],
      'scheme-org',
    ];
  }
}

/**
 * Implements hook_entity_bundle_field_info_alter().
 */
function donl_entity_bundle_field_info_alter(&$fields, EntityTypeInterface $entity_type, $bundle) {
  if (!empty($fields['identifier']) && in_array($bundle, ['catalog', 'organization'])) {
    $fields['identifier']->addConstraint('UniqueDonlIdentifier');
  }
  if (!empty($fields['forum_link'])) {
    $fields['forum_link']->addConstraint('DonlForumUrlConstraint');
  }
}

/**
 * Implements hook_form_alter().
 */
function donl_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $valueList = \Drupal::service('donl.value_list');

  // Globally alter the following fields.
  if (isset($form['theme']) && $form_id !== 'block_form') {
    $form['theme']['widget'][0]['value']['#type'] = 'select';
    $form['theme']['widget'][0]['value']['#options'] = $valueList->getPreparedHierarchicalThemeList(TRUE);
    $form['theme']['widget'][0]['value']['#empty_option'] = t('- Select item -');
    $form['theme']['widget'][0]['value']['#size'] = 1;
  }

  // Alter the datarequest form.
  if (in_array($form_id, ['node_datarequest_form', 'node_datarequest_edit_form'])) {
    $form['#title'] = t('Make a new data request');
    if ($form_id === 'node_datarequest_edit_form') {
      $form['#title'] = t('Edit @type', ['@type' => 'data request']);
    }

    $request = \Drupal::request();
    $possibleOwner = html_entity_decode($request->query->get('data_eigenaar', ''), ENT_QUOTES, 'UTF-8');
    $requestedData = html_entity_decode($request->query->get('gevraagde_data', ''), ENT_QUOTES, 'UTF-8');

    $form['data_owner']['widget'][0]['value']['#type'] = 'select';
    $form['data_owner']['widget'][0]['value']['#options'] = $valueList->getList('donl:organization');
    $form['data_owner']['widget'][0]['value']['#empty_option'] = t('- Select item -');
    $form['data_owner']['widget'][0]['value']['#size'] = 1;

    $form['requested_dataformat']['widget'][0]['value']['#type'] = 'select';
    $form['requested_dataformat']['widget'][0]['value']['#options'] = $valueList->getList('mdr:filetype_nal');
    $form['requested_dataformat']['widget'][0]['value']['#empty_option'] = t('- Select item -');
    $form['requested_dataformat']['widget'][0]['value']['#size'] = 1;

    $form['possible_owner']['widget'][0]['value']['#type'] = 'select';
    $form['possible_owner']['widget'][0]['value']['#options'] = $valueList->getList('donl:organization');
    $form['possible_owner']['widget'][0]['value']['#empty_option'] = t('- Select item -');
    $form['possible_owner']['widget'][0]['value']['#size'] = 1;
    if (!empty($possibleOwner)) {
      $form['possible_owner']['widget'][0]['value']['#default_value'] = $possibleOwner;
    }

    if (!empty($requestedData)) {
      $form['requested_data']['widget'][0]['value']['#default_value'] = $requestedData;
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function donl_form_node_feedback_dataset_form_alter(&$form, FormStateInterface $form_state) {
  $datasetId = \Drupal::request()->query->get('dataset', '');
  if (!$datasetId) {
    throw new NotFoundHttpException();
  }

  /* @var \Drupal\ckan\Entity\Dataset $dataset */
  $dataset = \Drupal::service('ckan.request')->getDataset($datasetId);
  if (!$dataset) {
    throw new NotFoundHttpException();
  }

  $form['data_eigenaar']['widget'][0]['value']['#default_value'] = $dataset->getAuthority();
  $form['data_eigenaar']['widget'][0]['value']['#value'] = $dataset->getAuthority();
  $form['data_eigenaar']['widget'][0]['value']['#disabled'] = TRUE;

  $form['titel_dataset']['widget'][0]['value']['#default_value'] = $dataset->getTitle();
  $form['titel_dataset']['widget'][0]['value']['#value'] = $dataset->getTitle();
  $form['titel_dataset']['widget'][0]['value']['#disabled'] = TRUE;

  $datasetLink = Url::fromRoute('ckan.dataset.view', ['dataset' => $dataset->getName()], ['absolute' => TRUE])->toString();
  $form['link_dataset']['widget'][0]['uri']['#default_value'] = $datasetLink;
  $form['link_dataset']['widget'][0]['uri']['#value'] = $datasetLink;
  $form['link_dataset']['widget'][0]['uri']['#disabled'] = TRUE;

  $form['#submit'][] = 'donl_form_node_feedback_dataset_form_alter_submit';
  $form['actions']['submit']['#submit'][] = 'donl_form_node_feedback_dataset_form_alter_submit';
}

/**
 * Custom sumbit handler for node_feedback_dataset_form.
 */
function donl_form_node_feedback_dataset_form_alter_submit(&$form, FormStateInterface $form_state) {
  $messenger = \Drupal::messenger();
  if ($messenger->messagesByType('status')) {
    $messenger->deleteByType('status');
    $messenger->addStatus(t('Your feedback with title %title has been saved and will be forwarded to the relevant data owner.', ['%title' => $form_state->getValue('title')[0]['value']]));
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function donl_form_node_appliance_form_alter(&$form, FormStateInterface $form_state) {
  $form['actions']['submit']['#submit'][] = 'donl_form_node_appliance_form_alter_submit';
}

/**
 * Custom sumbit handler for node_appliance_form.
 */
function donl_form_node_appliance_form_alter_submit(array $form, FormStateInterface $form_state) {
  $messenger = \Drupal::messenger();
  if ($messenger->messagesByType('status')) {
    $messenger->deleteByType('status');
    $messenger->addMessage(t('The application is being verified and awaiting approval.'));
  }
  $form_state->setRedirect('donl_search.search.application');
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function donl_form_node_form_alter(&$form, FormStateInterface $form_state) {
  $formIds = [
    'node_appliance_form',
    'node_datarequest_form',
    'node_feedback_dataset_form'
  ];
  if (in_array($form['#form_id'], $formIds)) {
    donl_add_privacy_fields($form);
  }
  return $form;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function donl_form_user_register_form_alter(&$form, FormStateInterface $form_state) {
  if ($form_state->getValue('step') === 2) {
    donl_add_privacy_fields($form);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function donl_form_user_login_form_alter(&$form, FormStateInterface $form_state) {
  $form['#submit'][] = 'donl_form_user_login_form_alter_submit';
}

/**
 * Custom sumbit handler for user_login_form.
 */
function donl_form_user_login_form_alter_submit($form, FormStateInterface $form_state) {
  $form_state->setRedirect('donl.profile.view');
}

/**
 * Helper function to add the privacy fields to existing forms.
 *
 * @param array $form
 */
function donl_add_privacy_fields(array &$form) {
  $form['privacy_info'] = [
    '#theme' => 'donl_privacy_statement',
    '#weight' => 49,
  ];
  $form['privacy_accept'] = [
    '#type' => 'fieldset',
    '#title' => t('Statement of agreement') . ' <small>' . t('Required field') . '</small>',
    '#weight' => 50,
    '#attributes' => [
      'class' => 'privacy-accept',
    ],
  ];
  $form['privacy_accept'][] = [
    '#type' => 'checkbox',
    '#title' => t('I have read and understood what is being done with my personal data.'),
    '#required' => TRUE,
    '#value' => 'accept',
  ];
}

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
function donl_node_presave(NodeInterface $node) {
  // Add the auto-increment datarequest number.
  if ($node->getType() === 'datarequest' && $node->id() === NULL && !$node->get('datarequest_id')->getValue()) {
    $query = \Drupal::database()->select('node__datarequest_id', 'n');
    $query->addExpression('MAX(datarequest_id_value)', 'max');
    $query->range(0, 1);
    $max = (int) $query->execute()->fetchField();
    $node->set('datarequest_id', $max + 1);
  }

  // Automatically set the machine name.
  if (in_array($node->getType(), ['appliance', 'datarequest', 'dataservice']) && !$node->get('machine_name')->getValue()) {
    $title = $node->getTitle();
    $title = preg_replace('~[^\pL\d_]+~u', '-', $title);
    $title = iconv('utf-8', 'us-ascii//TRANSLIT', $title);
    $title = preg_replace('~[^-\w]+~', '', $title);
    $title = trim($title, '-');
    $title = preg_replace('~-+~', '-', $title);
    $title = strtolower($title);
    if (mb_strwidth($title, 'UTF-8') > 100) {
      $title = rtrim(mb_substr($title, 0, 100, 'UTF-8'));
    }

    $i = 0;
    do {
      $machineName = $title . ($i > 0 ? '_' . $i : '');
      $query = \Drupal::entityQuery('node');
      $query->condition('type', $node->getType(), '=');
      $query->condition('machine_name', $machineName, '=');
      $i++;
    } while (count($query->execute()) !== 0);
    $node->set('machine_name', $machineName);
  }
}

/**
 * Implements hook_value_list_service_alter().
 */
function donl_value_list_service_alter(&$links) {
  $links[] = Link::createFromRoute('DCAT-AP-DONL - DONL:Organization', 'donl.value_list.organizations')->toString();
  $links[] = Link::createFromRoute('DCAT-AP-DONL - DONL:Catalogs', 'donl.value_list.catalog')->toString();
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function donl_menu_local_tasks_alter(&$data, $route_name) {
  // Remove the user view local task, because we replaced it with the profile
  // local task.
  if (in_array($route_name, ['donl.profile.view', 'entity.user.canonical'])) {
    unset($data['tabs']);
  }
}
